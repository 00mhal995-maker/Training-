<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8" />
    <title>Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ø§Ø³ØªÙ…Ø§Ø¹ - Step</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <style>
        body {
            font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
            background: #f5f7fb;
            margin: 0;
            padding: 0;
        }
        .container {
            max-width: 900px;
            margin: 30px auto;
            background: #ffffff;
            padding: 25px 20px;
            border-radius: 12px;
            box-shadow: 0 12px 30px rgba(0,0,0,0.08);
        }
        h1, h2, h3 {
            margin-top: 0;
            color: #222;
        }
        .subtitle {
            color: #666;
            font-size: 14px;
            margin-bottom: 20px;
        }
        .form-group {
            margin-bottom: 15px;
        }
        label {
            display: block;
            margin-bottom: 6px;
            font-weight: 600;
        }
        input[type="text"], select {
            width: 100%;
            box-sizing: border-box;
            padding: 10px 12px;
            border-radius: 8px;
            border: 1px solid #ccc;
            font-size: 14px;
        }
        button {
            border: none;
            border-radius: 999px;
            padding: 10px 22px;
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.1s ease, box-shadow 0.1s ease, background 0.2s;
        }
        button:active {
            transform: scale(0.97);
            box-shadow: none;
        }
        .btn-primary {
            background: #2563eb;
            color: #fff;
            box-shadow: 0 8px 18px rgba(37,99,235,0.35);
        }
        .btn-primary:hover {
            background: #1d4ed8;
        }
        .btn-secondary {
            background: #e5e7eb;
            color: #111827;
        }
        .hidden {
            display: none;
        }
        .audio-box {
            padding: 15px;
            background: #f3f4ff;
            border-radius: 10px;
            border: 1px solid #d4d7ff;
            margin-bottom: 20px;
        }
        .question-card {
            padding: 15px;
            border-radius: 10px;
            border: 1px solid #e5e7eb;
            margin-bottom: 15px;
            background: #fafafa;
        }
        .question-title {
            font-weight: 600;
            margin-bottom: 10px;
        }
        .options {
            list-style: none;
            padding: 0;
            margin: 0;
        }
        .options li {
            margin-bottom: 6px;
        }
        .options label {
            font-weight: normal;
            display: flex;
            gap: 8px;
            align-items: center;
        }
        .options input[type="radio"] {
            margin-left: 4px;
        }
        .header-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        .badge {
            display: inline-block;
            padding: 4px 10px;
            border-radius: 999px;
            background: #e0f2fe;
            color: #075985;
            font-size: 12px;
            font-weight: 600;
        }
        .timer {
            font-size: 14px;
            font-weight: 600;
            color: #16a34a;
        }
        .result-box {
            margin-top: 20px;
            padding: 15px;
            border-radius: 10px;
            background: #ecfdf3;
            border: 1px solid #bbf7d0;
            color: #14532d;
        }
        .footer-note {
            margin-top: 20px;
            font-size: 12px;
            color: #9ca3af;
            text-align: center;
        }
    </style>
</head>
<body>
<div class="container">

    <div id="intro-section">
        <h1>Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ø§Ø³ØªÙ…Ø§Ø¹</h1>
        <p class="subtitle">
            Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ø§Ø³Ù… ÙˆØ§Ù„Ø´Ø¹Ø¨Ø© Ù‚Ø¨Ù„ Ø¨Ø¯Ø¡ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±. Ø³ÙŠØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø±Ø¬Ø© ÙˆÙˆÙ‚Øª Ø§Ù„Ø­Ù„ ÙÙŠ Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ….
        </p>

        <div class="form-group">
            <label for="studentName">Ø§Ø³Ù… Ø§Ù„Ø·Ø§Ù„Ø¨</label>
            <input type="text" id="studentName" placeholder="Ù…Ø«Ø§Ù„: Ù…Ø­Ù…Ø¯ Ø¹Ù„ÙŠ" />
        </div>

        <div class="form-group">
            <label for="studentSection">Ø§Ù„Ø´Ø¹Ø¨Ø©</label>
            <input type="text" id="studentSection" placeholder="Ù…Ø«Ø§Ù„: Ø´Ø¹Ø¨Ø© 101" />
        </div>

        <button class="btn-primary" id="startBtn">Ø§Ø¨Ø¯Ø£ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±</button>
    </div>

    <div id="test-section" class="hidden">
        <div class="header-bar">
            <div>
                <h2 style="margin: 0;">Ù‚Ø³Ù… Ø§Ù„Ø£Ø³Ø¦Ù„Ø©</h2>
                <span class="badge" id="studentInfoBadge"></span>
            </div>
            <div class="timer" id="timerDisplay">Ø§Ù„ÙˆÙ‚Øª: 00:00</div>
        </div>

        <div class="audio-box">
            <h3 style="margin-top:0;">Ø§Ø³ØªÙ…Ø¹ Ø¥Ù„Ù‰ Ø§Ù„Ù…Ù‚Ø·Ø¹ Ø§Ù„ØªØ§Ù„ÙŠ:</h3>
            <!-- Ø§Ù„Ù…Ù„Ù Ø§Ù„ØµÙˆØªÙŠ Ø³ÙŠØªÙ… ØªØ­Ù…ÙŠÙ„Ù‡ Ù‡Ù†Ø§ Ø¹Ø¨Ø± Firebase -->
            <audio id="listeningAudio" controls>
                <source id="audioSource" type="audio/mpeg" />
                Ø§Ù„Ù…ØªØµÙØ­ Ù„Ø§ ÙŠØ¯Ø¹Ù… ØªØ´ØºÙŠÙ„ Ø§Ù„ØµÙˆØª.
            </audio>
        </div>

        <div id="questionsContainer">
            <!-- Ø³ÙŠØªÙ… ØªØ¹Ø¨Ø¦Ø© Ø§Ù„Ø£Ø³Ø¦Ù„Ø© Ø¯ÙŠÙ†Ø§Ù…ÙŠÙƒÙŠØ§Ù‹ Ù…Ù† Firebase -->
        </div>

        <button class="btn-primary" id="submitBtn">Ø¥Ø±Ø³Ø§Ù„ ÙˆØ¥Ù†Ù‡Ø§Ø¡ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±</button>

        <div id="resultBox" class="result-box hidden"></div>
    </div>

    <div class="footer-note">
        ØªÙ… ØªØ·ÙˆÙŠØ± Ù‡Ø°Ø§ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø± Ù„Ø£ØºØ±Ø§Ø¶ ØªØ¹Ù„ÙŠÙ…ÙŠØ© ğŸ’»ğŸ§
    </div>
</div>

<!-- Firebase SDK -->
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>

<script>
    // Ø¥Ø¹Ø¯Ø§Ø¯ Firebase
    const firebaseConfig = {
        apiKey: "AIzaSyCqDJvWVMz2blT9P4vrEQQ5CpFAZZBS9Eo",
        authDomain: "classwithonline.firebaseapp.com",
        databaseURL: "https://classwithonline-default-rtdb.asia-southeast1.firebasedatabase.app",
        projectId: "classwithonline",
        storageBucket: "classwithonline.firebasestorage.app",
        messagingSenderId: "253846485060",
        appId: "1:253846485060:web:50287705cd9be34ca0e411",
        measurementId: "G-M9XFLBQZFL"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    const introSection = document.getElementById('intro-section');
    const testSection = document.getElementById('test-section');
    const startBtn = document.getElementById('startBtn');
    const submitBtn = document.getElementById('submitBtn');
    const studentNameInput = document.getElementById('studentName');
    const studentSectionInput = document.getElementById('studentSection');
    const questionsContainer = document.getElementById('questionsContainer');
    const resultBox = document.getElementById('resultBox');
    const studentInfoBadge = document.getElementById('studentInfoBadge');
    const timerDisplay = document.getElementById('timerDisplay');

    let questions = [];
    let startTime = null;
    let timerInterval = null;
    let currentStudent = {
        name: '',
        section: ''
    };

    // ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø£Ø³Ø¦Ù„Ø© Ù…Ù† Firebase
    function loadQuestions() {
        questionsContainer.innerHTML = "<p>Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø£Ø³Ø¦Ù„Ø©...</p>";
        db.ref('questions').once('value')
            .then(snapshot => {
                questions = [];
                snapshot.forEach(child => {
                    const q = child.val();
                    questions.push({
                        id: child.key,
                        text: q.text,
                        options: q.options,
                        correctIndex: q.correctIndex
                    });
                });

                if (questions.length === 0) {
                    questionsContainer.innerHTML = "<p style='color:#b91c1c;'>Ù„Ø§ ØªÙˆØ¬Ø¯ Ø£Ø³Ø¦Ù„Ø© Ù…Ø¶Ø§ÙØ© Ø­ØªÙ‰ Ø§Ù„Ø¢Ù†. ØªÙˆØ§ØµÙ„ Ù…Ø¹ Ø§Ù„Ù…Ø¹Ù„Ù….</p>";
                } else {
                    renderQuestions();
                }
            })
            .catch(err => {
                console.error(err);
                questionsContainer.innerHTML = "<p style='color:#b91c1c;'>Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø£Ø³Ø¦Ù„Ø©.</p>";
            });
    }

    // Ø±Ø³Ù… Ø§Ù„Ø£Ø³Ø¦Ù„Ø© ÙÙŠ Ø§Ù„ØµÙØ­Ø©
    function renderQuestions() {
        questionsContainer.innerHTML = '';
        questions.forEach((q, index) => {
            const card = document.createElement('div');
            card.className = 'question-card';

            const title = document.createElement('div');
            title.className = 'question-title';
            title.textContent = `Ø§Ù„Ø³Ø¤Ø§Ù„ ${index + 1}: ${q.text}`;
            card.appendChild(title);

            const ul = document.createElement('ul');
            ul.className = 'options';

            q.options.forEach((opt, optIndex) => {
                const li = document.createElement('li');
                const label = document.createElement('label');

                const input = document.createElement('input');
                input.type = 'radio';
                input.name = `q_${q.id}`;
                input.value = optIndex;

                label.appendChild(input);
                label.appendChild(document.createTextNode(opt));

                li.appendChild(label);
                ul.appendChild(li);
            });

            card.appendChild(ul);
            questionsContainer.appendChild(card);
        });
    }

    // ØªØ´ØºÙŠÙ„ Ø§Ù„Ù…Ø¤Ù‚Øª
    function startTimer() {
        startTime = new Date();
        timerInterval = setInterval(() => {
            const now = new Date();
            const diff = Math.floor((now - startTime) / 1000); // Ø¨Ø§Ù„Ø«ÙˆØ§Ù†ÙŠ
            const minutes = String(Math.floor(diff / 60)).padStart(2, '0');
            const seconds = String(diff % 60).padStart(2, '0');
            timerDisplay.textContent = `Ø§Ù„ÙˆÙ‚Øª: ${minutes}:${seconds}`;
        }, 1000);
    }

    // Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„Ù…Ø¤Ù‚Øª ÙˆØ­Ø³Ø§Ø¨ Ù…Ø¯Ø© Ø§Ù„Ø­Ù„
    function stopTimer() {
        if (!startTime) return 0;
        clearInterval(timerInterval);
        const endTime = new Date();
        const diffSeconds = Math.floor((endTime - startTime) / 1000);
        return diffSeconds;
    }

    // Ø¹Ù†Ø¯ Ø§Ù„Ø¶ØºØ· Ø¹Ù„Ù‰ "Ø§Ø¨Ø¯Ø£ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±"
    startBtn.addEventListener('click', () => {
        const name = studentNameInput.value.trim();
        const section = studentSectionInput.value.trim();

        if (!name || !section) {
            alert('ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ø§Ø³Ù… ÙˆØ§Ù„Ø´Ø¹Ø¨Ø©.');
            return;
        }

        currentStudent.name = name;
        currentStudent.section = section;

        studentInfoBadge.textContent = `${name} - ${section}`;

        introSection.classList.add('hidden');
        testSection.classList.remove('hidden');
        resultBox.classList.add('hidden');

        loadQuestions();
        startTimer();
    });

    // Ø¹Ù†Ø¯ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±
    submitBtn.addEventListener('click', () => {
        if (questions.length === 0) {
            alert('Ù„Ø§ ØªÙˆØ¬Ø¯ Ø£Ø³Ø¦Ù„Ø© Ù„Ù„Ø¥Ø±Ø³Ø§Ù„.');
            return;
        }

        if (!confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±ØŸ Ù„Ù† ØªØªÙ…ÙƒÙ† Ù…Ù† Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ Ø¨Ø¹Ø¯ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„.')) {
            return;
        }

        const durationSeconds = stopTimer();
        let score = 0;
        const total = questions.length;
        const answers = {};

        questions.forEach(q => {
            const selected = document.querySelector(`input[name="q_${q.id}"]:checked`);
            const selectedIndex = selected ? parseInt(selected.value) : null;
            const isCorrect = selectedIndex === q.correctIndex;

            if (isCorrect) score++;

            answers[q.id] = {
                selectedIndex: selectedIndex,
                correctIndex: q.correctIndex
            };
        });

        // Ø­ÙØ¸ Ø§Ù„Ù†ØªÙŠØ¬Ø© ÙÙŠ Firebase
        const resultData = {
            studentName: currentStudent.name,
            studentSection: currentStudent.section,
            score: score,
            total: total,
            durationSeconds: durationSeconds,
            submittedAt: new Date().toISOString(),
            answers: answers
        };

        db.ref('results').push(resultData)
            .then(() => {
                const minutes = Math.floor(durationSeconds / 60);
                const seconds = durationSeconds % 60;

                resultBox.innerHTML = `
                    <strong>ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø± Ø¨Ù†Ø¬Ø§Ø­ âœ…</strong><br/>
                    Ø¯Ø±Ø¬ØªÙƒ: ${score} Ù…Ù† ${total}<br/>
                    Ø²Ù…Ù† Ø§Ù„Ø­Ù„: ${minutes} Ø¯Ù‚ÙŠÙ‚Ø© Ùˆ ${seconds} Ø«Ø§Ù†ÙŠØ©
                `;
                resultBox.classList.remove('hidden');
                submitBtn.disabled = true;
                submitBtn.textContent = "ØªÙ… Ø§Ù„Ø¥Ø±Ø³Ø§Ù„";
            })
            .catch(err => {
                console.error(err);
                alert('Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø­ÙØ¸ Ø§Ù„Ù†ØªÙŠØ¬Ø©. Ø­Ø§ÙˆÙ„ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰.');
                startTimer(); // ÙÙŠ Ø­Ø§Ù„ ÙØ´Ù„ Ø§Ù„Ø­ÙØ¸ Ù†Ø¹ÙŠØ¯ Ø§Ù„Ù…Ø¤Ù‚Øª
            });
    });
</script>
</body>
</html>
